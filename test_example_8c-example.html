<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CIMUnit: test_example.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CIMUnit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">test_example.c</div>  </div>
</div>
<div class="contents">
<p>This example shows a walk through of how CIMUnit operates.</p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#include &quot;<a class="code" href="cimunit_8h.html">cimunit.h</a>&quot;</span>
<span class="preprocessor">#include &quot;../concurrent_queue.h&quot;</span>
<span class="preprocessor">#include &lt;assert.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>

<span class="keyword">typedef</span> <span class="keyword">struct</span>{
  <a name="_a0"></a><a class="code" href="structcimunit__schedule.html" title="Structure use to define a CIMUnit schedule.">cimunit_schedule_t</a> *schedule;
  concurrent_queue_t *queue;
  <span class="keywordtype">int</span> dequeued_value;
  <span class="keywordtype">int</span> dequeue_return_val;
} thread_args_t;


<span class="keywordtype">void</span> *consumer_function(<span class="keywordtype">void</span> *args);
<span class="keywordtype">void</span> *producer_function(<span class="keywordtype">void</span> *args);

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]){
  <span class="keywordtype">int</span> error = 0;

  concurrent_queue_t queue;
  concurrent_queue_init(&amp;queue);
   

  <a class="code" href="structcimunit__schedule.html" title="Structure use to define a CIMUnit schedule.">cimunit_schedule_t</a> *schedule = <a name="a1"></a><a class="code" href="group__cimunit__schedule.html#ga61ff8f64cc0c3cda683e87e92043a73c">cimunit_schedule_parse</a>(
    <span class="stringliteral">&quot;end_enqueue1-&gt;start_dequeue1&quot;</span>);

  thread_args_t args;
  args.queue = &amp;queue;
  args.schedule = schedule;
  args.dequeued_value = 0;
  args.dequeue_return_val = 0;

  pthread_t producer_thread;
  pthread_t consumer_thread;
  pthread_create(&amp;producer_thread, NULL, producer_function, (<span class="keywordtype">void</span>*)(&amp;args));
  pthread_create(&amp;consumer_thread, NULL, consumer_function, (<span class="keywordtype">void</span>*)(&amp;args));

  pthread_join(producer_thread, NULL);
  pthread_join(consumer_thread, NULL);

  <span class="keywordtype">size_t</span> queue_size;
  concurrent_queue_size(&amp;queue, &amp;queue_size);
  <span class="keywordflow">if</span>(args.dequeued_value == 5 &amp;&amp;
     args.dequeue_return_val == 0 &amp;&amp;
     queue_size == 0)
  {
    printf(<span class="stringliteral">&quot;Test 1 passed :)\n&quot;</span>);
  }
  <span class="keywordflow">else</span>{
    fprintf(stderr, <span class="stringliteral">&quot;Test 1 failed!\n&quot;</span>);
    fprintf(stderr, <span class="stringliteral">&quot;Dequeued value was: %d\n&quot;</span>, args.dequeued_value);
    fprintf(stderr, <span class="stringliteral">&quot;Dequeue return value was: %d\n&quot;</span>, args.dequeue_return_val);
    fprintf(stderr, <span class="stringliteral">&quot;Size was: %zu\n&quot;</span>, queue_size);
    error +=1;
  }

  <a name="a2"></a><a class="code" href="group__cimunit__schedule.html#ga72f4771cf3b96241da1791e3fabb14b7" title="Destroy the schedule object and free memory.">cimunit_schedule_destroy</a>(schedule);
  concurrent_queue_destroy(&amp;queue);


  schedule = <a class="code" href="group__cimunit__schedule.html#ga61ff8f64cc0c3cda683e87e92043a73c">cimunit_schedule_parse</a>(<span class="stringliteral">&quot;end_dequeue1-&gt;start_enqueue1&quot;</span>);
 
  concurrent_queue_init(&amp;queue);
  args.dequeued_value=0;
  args.dequeue_return_val = 0;
  args.schedule = schedule;
  
  pthread_create(&amp;producer_thread, NULL, producer_function, (<span class="keywordtype">void</span>*)(&amp;args));
  pthread_create(&amp;consumer_thread, NULL, consumer_function, (<span class="keywordtype">void</span>*)(&amp;args));
  pthread_join(producer_thread, NULL);
  pthread_join(consumer_thread, NULL);


  concurrent_queue_size(&amp;queue, &amp;queue_size);
  <span class="keywordflow">if</span>(args.dequeued_value == 0 &amp;&amp; 
     args.dequeue_return_val != 0 &amp;&amp;
     queue_size == 1)
  {
    printf(<span class="stringliteral">&quot;Test 2 passed :)\n&quot;</span>);
  }
  <span class="keywordflow">else</span>{
    fprintf(stderr, <span class="stringliteral">&quot;Test 2 failed!\n&quot;</span>);
    fprintf(stderr, <span class="stringliteral">&quot;Dequeued value was: %d\n&quot;</span>, args.dequeued_value);
    fprintf(stderr, <span class="stringliteral">&quot;Dequeue return value was: %d\n&quot;</span>, args.dequeue_return_val);
    fprintf(stderr, <span class="stringliteral">&quot;Size was: %zu\n&quot;</span>, queue_size);
    error +=1;
  }

  <a class="code" href="group__cimunit__schedule.html#ga72f4771cf3b96241da1791e3fabb14b7" title="Destroy the schedule object and free memory.">cimunit_schedule_destroy</a>(schedule);
  concurrent_queue_destroy(&amp;queue);
  
  <span class="keywordflow">return</span> error;
}

<span class="keywordtype">void</span> *consumer_function(<span class="keywordtype">void</span> *args){
  thread_args_t *thread_args = (thread_args_t*)args;
  concurrent_queue_t *queue = thread_args-&gt;queue;
  <a class="code" href="structcimunit__schedule.html" title="Structure use to define a CIMUnit schedule.">cimunit_schedule_t</a> *schedule = thread_args-&gt;schedule;

  <a name="a3"></a><a class="code" href="group__cimunit__schedule.html#ga51236ae0abd30f98baa140eed1ab7a3c">cimunit_schedule_fire</a>(schedule, <span class="stringliteral">&quot;start_dequeue1&quot;</span>);
  thread_args-&gt;dequeue_return_val = 
    concurrent_queue_dequeue(queue, &amp;(thread_args-&gt;dequeued_value));
  <a class="code" href="group__cimunit__schedule.html#ga51236ae0abd30f98baa140eed1ab7a3c">cimunit_schedule_fire</a>(schedule, <span class="stringliteral">&quot;end_dequeue1&quot;</span>);
}

<span class="keywordtype">void</span> *producer_function(<span class="keywordtype">void</span> *args){
  thread_args_t *thread_args = (thread_args_t*)args;
  concurrent_queue_t *queue = thread_args-&gt;queue;
  <a class="code" href="structcimunit__schedule.html" title="Structure use to define a CIMUnit schedule.">cimunit_schedule_t</a> *schedule = thread_args-&gt;schedule;
  
  <a class="code" href="group__cimunit__schedule.html#ga51236ae0abd30f98baa140eed1ab7a3c">cimunit_schedule_fire</a>(schedule, <span class="stringliteral">&quot;start_enqueue1&quot;</span>);
  concurrent_queue_enqueue(queue, 5);
  <a class="code" href="group__cimunit__schedule.html#ga51236ae0abd30f98baa140eed1ab7a3c">cimunit_schedule_fire</a>(schedule, <span class="stringliteral">&quot;end_enqueue1&quot;</span>);
}

</pre></div> </div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Dec 1 2011 22:05:25 for CIMUnit by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
